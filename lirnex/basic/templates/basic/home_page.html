{% extends 'basic/home.html' %}

{% block title %}Lirnex{% endblock %}

{% block content %}

<h3 style="text-align: center;">–ü–æ—Å—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –Ω–∞ —è–∫–∏—Ö –≤–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ</h3>

<div class="feed-container">
{% for post in posts %}
<div class="post">
    <div class="creator">
        <h4>
            <img src="{{ post.author.profile.photo_profile.url }}" class="profile-pic"
                 style="width:30px; height:30px; border-radius:50%;">
        </h4>
        <a href="{% url 'user:profile' post.author.username %}">
            {{ post.author.username }}
        </a>
    </div>

    {% for media in post.media.all %}
    <a href="{% url 'basic:post_detail' post.pk %}" class="post-link">
        {% if media.is_image %}
            <img src="{{ media.file.url }}" alt="" style="max-width:400px;">
        {% elif media.is_video %}
            <video controls style="max-width:400px;">
                <source src="{{ media.file.url }}" type="video/mp4">
            </video>
        {% endif %}
    {% endfor %}
    </a>    
    {# –ö–Ω–æ–ø–∫–∞ –ª–∞–π–∫—É #}
    <button class="like-btn" 
            data-id="{{ post.id }}" 
            style="color: {% if post.liked_by_user %}red{% else %}black{% endif %};">
        ‚ù§Ô∏è <span class="like-count">{{ post.likes.count }}</span>
    </button>
<a href="{% url 'basic:post_detail' post.pk %}" class="post-link">
    üí¨ {{ post.comments.count }}
</a>



    <p>{{ post.caption|linebreaks }}</p>
</div>
{% empty %}
<p style="text-align: center;">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ—Å—Ç—ñ–≤.</p>
{% endfor %}
</div>

<div id="delete-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div style="background:#111; padding:20px; border-radius:8px; color:white; text-align:center;">
        <p>–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–æ–º–µ–Ω—Ç–∞—Ä?</p>
        <button id="confirm-delete" style="margin-right:10px; background:red; color:white; padding:5px 10px;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        <button id="cancel-delete" style="background:#555; color:white; padding:5px 10px;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
</div>





<script>
document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", function(e) {
        e.preventDefault();
        const postId = this.dataset.id;
        const button = this;

        fetch(`/post/${postId}/like/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie('csrftoken'),
                "Accept": "application/json",
            },
        })
        .then(res => res.json())
        .then(data => {
            button.querySelector(".like-count").textContent = data.likes_count;
            button.style.color = data.liked ? "red" : "black";
        })
        .catch(err => console.error("Error:", err));
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let commentToDelete = null; // —Ö—Ä–∞–Ω–∏—Ç id –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏ URL

function setupDeleteButtons() {
    document.querySelectorAll(".delete-comment-btn").forEach(btn => {
        if (!btn.dataset.listener) {
            btn.addEventListener("click", function(e) {
                e.preventDefault();
                commentToDelete = {
                    id: this.closest('.comment').id.replace('comment-', ''),
                    url: this.dataset.url
                };
                document.getElementById("delete-modal").style.display = "flex"; // –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
            });
            btn.dataset.listener = "true";
        }
    });
}

// –ö–Ω–æ–ø–∫–∞ "–í–∏–¥–∞–ª–∏—Ç–∏"
document.getElementById("confirm-delete").addEventListener("click", function() {
    if (!commentToDelete) return;
    fetch(commentToDelete.url, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            document.getElementById(`comment-${data.comment_id}`)?.remove();
            const countElem = document.getElementById("comments-count");
            countElem.textContent = `üí¨ ${document.getElementById("comments").children.length}`;
        } else {
            alert(data.error);
        }
        document.getElementById("delete-modal").style.display = "none";
        commentToDelete = null;
    });
});

// –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏"
document.getElementById("cancel-delete").addEventListener("click", function() {
    document.getElementById("delete-modal").style.display = "none";
    commentToDelete = null;
});

</script>

{% endblock %}
