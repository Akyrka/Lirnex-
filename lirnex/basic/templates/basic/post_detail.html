{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>{{ post.author.username }} — Пост</title>
    <link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #111;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            padding-top: 20px;
        }

        .post-wrapper {
            display: flex;
            background: #000;
            border: 1px solid #333;
            width: 80%;
            max-height: 90vh;
        }

        .media-block {
            width: 60%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-block img,
        .media-block video {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }

        .comments-panel {
            width: 40%;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            background: #0c0c0c;
        }

        .post-header {
            padding: 15px;
            font-size: 17px;
            border-bottom: 1px solid #333;
        }

        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .comment {
            margin-bottom: 15px;
        }

        .comment-user {
            font-weight: bold;
            margin-right: 5px;
        }

        .comment-form {
            border-top: 1px solid #333;
            padding: 10px;
            display: flex;
        }

        .comment-form input {
            flex: 1;
            padding: 10px;
            background: #222;
            border: 1px solid #444;
            color: white;
        }

        .comment-form button {
            margin-left: 10px;
            padding: 10px 15px;
            background: #0095f6;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }

        .back-btn {
            color: #888;
            margin-left: 10px;
            font-size: 14px;
        }

        .delete-comment-btn {
            margin-left: 10px;
            color: red;
            background: none;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

<div class="post-wrapper">

    <!-- LEFT SIDE: MEDIA -->
    <div class="media-block">
        {% for media in post.media.all %}
            {% if media.is_image %}
                <img src="{{ media.file.url }}" alt="">
            {% elif media.is_video %}
                <video src="{{ media.file.url }}" controls></video>
            {% endif %}
        {% endfor %}
    </div>

    <!-- RIGHT SIDE: COMMENTS -->
    <div class="comments-panel">

        <div class="post-header">
            <strong>{{ post.author.username }}</strong><br>
            <span style="font-size: 13px; color: #aaa;">
                {{ post.created_at|date:"d.m.Y H:i" }}
            </span>
            <button class="like-btn" 
                    data-id="{{ post.id }}" 
                    style="color: {% if post.liked_by_user %}red{% else %}black{% endif %};">
                ❤️ <span class="like-count">{{ post.likes.count }}</span>
            </button>
            <a href="{{ request.META.HTTP_REFERER|default:'/' }}" class="back-btn">← Назад</a>

            {% if request.user == post.author %}
                <br>
                <a href="{% url 'basic:post-delete' post.pk %}" style="color:red;">Видалити</a>
            {% endif %}
        </div>

        <!-- COMMENTS LIST -->
        <div class="comments-list" id="comments">
            {% for c in post.comments.all %}
                <div class="comment" id="comment-{{ c.pk }}">
                    <span class="comment-user">{{ c.user.username }}</span>
                    {{ c.text }}
                    {% if c.user == request.user %}
                        <button class="delete-comment-btn" data-url="{% url 'basic:delete_comment' c.pk %}">✖</button>
                    {% endif %}
                </div>
            {% empty %}
                <p style="color:#777;">Коментарів ще немає</p>
            {% endfor %}
        </div>

        <!-- ADD COMMENT -->
        {% if request.user.is_authenticated %}
        <form class="comment-form" method="POST" action="{% url 'basic:add_comment' post.id %}">
            {% csrf_token %}
            <input type="text" name="text" placeholder="Додати коментар..." required>
            <button type="submit">Send</button>
        </form>
        {% endif %}

    </div>

<script>
// CSRF
function getCookie(name) {
    return document.cookie.split('; ').find(row => row.startsWith(name + '='))
        ?.split('=')[1];
}

document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", function(e) {
        e.preventDefault();
        const postId = this.dataset.id;
        const button = this;

        fetch(`/post/${postId}/like/`, {  // URL должен совпадать с твоим urls.py
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie('csrftoken'),
                "Accept": "application/json",
            },
        })
        .then(res => res.json())
        .then(data => {
            button.querySelector(".like-count").textContent = data.likes_count;
            button.style.color = data.liked ? "red" : "black";
        })
        .catch(err => console.error("Error:", err));
    });
});

// функция для CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


// Add comment AJAX
document.querySelector(".comment-form")?.addEventListener("submit", function(e) {
    e.preventDefault();
    const input = this.querySelector("input[name='text']");
    const text = input.value.trim();
    if (!text) return;

    fetch(this.action, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        },
        body: new FormData(this)
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) return alert(data.error);

        const list = document.getElementById("comments");
        const div = document.createElement("div");
        div.classList.add("comment");
        div.id = `comment-${data.id}`;
        div.innerHTML = `
            <span class="comment-user">${data.username}</span>
            ${data.text}
            <button class="delete-comment-btn" data-url="${data.delete_url}">✖</button>
        `;
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
        input.value = "";

        setupDeleteButtons(); // навешиваем слушатель на новую кнопку
    });
});

// Delete comment AJAX
function setupDeleteButtons() {
    document.querySelectorAll(".delete-comment-btn").forEach(btn => {
        if (!btn.dataset.listener) {
            btn.addEventListener("click", function(e) {
                e.preventDefault();
                const url = this.dataset.url;

                fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success){
                        document.getElementById(`comment-${data.comment_id}`)?.remove();
                    } else {
                        alert(data.error);
                    }
                });
            });
            btn.dataset.listener = "true";
        }
    });
}

// Навешиваем слушатели на старые кнопки при загрузке
setupDeleteButtons();

</script>

</div>

</body>
</html>
